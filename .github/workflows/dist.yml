name: Build and push

on:
  push:
    branches:
      - develop

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        node-version: [20]
    steps:
    - uses: actions/checkout@v4
    - name: Install pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 8
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'
        cache: 'pnpm'
    - name: Install dependencies
      run: pnpm install
    - name: Build
      run: pnpm run build
    - name: Copy build artifacts to dist
      run: |
        find . -type d ! -name 'dist' -exec rm -rf {} + # remove all directories except dist
        mv dist/* . # move all files from dist to root
        rm -rf dist # remove dist directory
    - name: Commit and push changes
      env:
        TARGET_BRANCH: "build"
      run: |
        git fetch # fetch branches
        git checkout ${TARGET_BRANCH} # checkout to your branch
        git config --global user.name 'devops-devdocs' # set your username
        git config --global user.email 'magento-devops-devdocs-int@adobe.com' # set your email
        git add --all # add all changed files
        git diff-index --quiet HEAD || git commit -am "$(git rev-parse --short $GITHUB_SHA): deploy files" # commit to the repository (ignore if no modification)
        git push origin ${TARGET_BRANCH} # push to the remote target branch
